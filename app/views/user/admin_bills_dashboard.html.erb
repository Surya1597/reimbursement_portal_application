<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Bills dashboard</h1>
    <p class="text-muted mb-0">Review every employee submission in one place.</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to "Users dashboard", admin_users_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-5 g-3 mb-4">
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase mb-2">Total bills</h6>
        <h3 class="mb-0"><%= @total_bills %></h3>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase mb-2">Approved</h6>
        <h3 class="mb-1"><%= @approved_bills %></h3>
        <p class="text-muted mb-0"><small>₹<%= @approved_amount %></small></p>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase mb-2">Pending</h6>
        <h3 class="mb-1"><%= @pending_bills %></h3>
        <p class="text-muted mb-0"><small>₹<%= @pending_amount %></small></p>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase mb-2">Rejected</h6>
        <h3 class="mb-1"><%= @rejected_bills %></h3>
        <p class="text-muted mb-0"><small>₹<%= @rejected_amount %></small></p>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card text-center h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase mb-2">Total requested</h6>
        <h3 class="mb-0">₹<%= @total_amount %></h3>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header bg-white">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">All bills</h2>
      <span class="text-muted"><%= @bills.size %> records</span>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @bills.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Employee</th>
              <th scope="col">Department</th>
              <th scope="col">Amount</th>
              <th scope="col">Type</th>
              <th scope="col">Reason</th>
              <th scope="col">Status</th>
              <th scope="col">Submitted</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @bills.each do |bill| %>
              <% profile = bill.employee_profile %>
              <% employee_name = [profile&.first_name, profile&.last_name].compact.join(" ") %>
              <% department_name = profile&.department&.name || "—" %>
              <% status_badge_class = case bill.status
                                      when "approved" then "bg-success"
                                      when "rejected" then "bg-danger"
                                      else "bg-warning text-dark"
                                      end %>
              <tr>
                <td>
                  <p class="fw-semibold mb-0"><%= employee_name.presence || "Unassigned" %></p>
                  <p class="text-muted mb-0"><small><%= profile&.user&.email %></small></p>
                </td>
                <td><%= department_name %></td>
                <td><%= number_to_currency(bill.amount, unit: "₹") %></td>
                <td class="text-capitalize"><%= bill.bill_type %></td>
                <td>
                  <% if bill.bill_type == "other" %>
                    <small><%= bill.other_reason.presence || "—" %></small>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge <%= status_badge_class %>"><%= bill.status.titleize %></span>
                </td>
                <td>
                  <small class="text-muted"><%= bill.created_at.strftime("%d %b %Y %l:%M %p") %></small>
                </td>
                <td class="text-end">
                  <div class="d-inline-flex gap-2">
                    <%= button_to "Approve",
                                  bill_path(bill),
                                  method: :patch,
                                  params: { bill: { status: :approved } },
                                  class: "btn btn-sm btn-success",
                                  disabled: bill.approved?,
                                  form: { class: "d-inline", data: { turbo_confirm: "Mark this bill as approved?" } } %>
                    <%= button_to "Reject",
                                  bill_path(bill),
                                  method: :patch,
                                  params: { bill: { status: :rejected } },
                                  class: "btn btn-sm btn-outline-danger",
                                  disabled: bill.rejected?,
                                  form: { class: "d-inline", data: { turbo_confirm: "Reject this bill?" } } %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <p class="text-muted mb-0">No bills have been submitted yet.</p>
      </div>
    <% end %>
  </div>
</div>
