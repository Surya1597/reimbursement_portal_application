<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Users dashboard</h1>
    <p class="text-muted mb-0">See every account and their employee profile details.</p>
  </div>
  <div class="d-flex gap-2">
    <%= link_to "Bills dashboard", admin_bills_dashboard_path, class: "btn btn-outline-secondary" %>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
      Create user
    </button>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <% if @users.any? %>
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Role</th>
              <th scope="col">Department</th>
              <th scope="col">Designation</th>
              <th scope="col">Created</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |user| %>
              <% profile = user.employee_profile %>
              <tr>
                <td class="fw-semibold"><%= user.name %></td>
                <td><%= mail_to user.email %></td>
                <td><span class="badge bg-primary-subtle text-primary text-uppercase"><%= user.role %></span></td>
                <td><%= profile&.department&.name || "—" %></td>
                <td><%= profile&.designation&.humanize || "—" %></td>
                <td><small class="text-muted"><%= user.created_at.strftime("%d %b %Y") %></small></td>
                <td>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#editUserModal-<%= user.id %>">
                      Edit
                    </button>
                    <%= button_to "Delete",
                                  admin_user_path(user),
                                  method: :delete,
                                  class: "btn btn-sm btn-outline-danger",
                                  data: { turbo_confirm: "Delete #{user.name}?" } %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <p class="text-muted mb-0">No users found.</p>
      </div>
    <% end %>
  </div>
</div>

<%= render "user/user_modal",
           modal_id: "newUserModal",
           title: "Create new user",
           user: @new_user,
           url: admin_users_path,
           method: :post,
           submit_label: "Create user",
           departments: @departments,
           designation_options: @designation_options,
           require_password: true %>

<% @users.each do |user| %>
  <%= render "user/user_modal",
             modal_id: "editUserModal-#{user.id}",
             title: "Edit #{user.name}",
             user: user,
             url: admin_user_path(user),
             method: :patch,
             submit_label: "Update user",
             departments: @departments,
             designation_options: @designation_options,
             require_password: false %>
<% end %>

<% if @open_new_user_modal %>
  <script>
    (function openNewUserModal() {
      var showModal = function () {
        var modalEl = document.getElementById("newUserModal");
        if (modalEl) {
          var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", showModal);
      } else {
        showModal();
      }
    })();
  </script>
<% end %>

<% if @edited_user_id.present? %>
  <script>
    (function openEditModal() {
      var showModal = function () {
        var modalEl = document.getElementById("editUserModal-<%= @edited_user_id %>");
        if (modalEl) {
          var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", showModal);
      } else {
        showModal();
      }
    })();
  </script>
<% end %>
